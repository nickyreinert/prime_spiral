<!DOCTYPE html>
<!-- https://en.wikipedia.org/wiki/Ulam_spiral -->
<html>
  <head>
    <meta charset="utf-8">
    <title>Prime-Spiral</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #fff;
      }
      #container {
        position: relative;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      #canvas {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;

      }

      .slider_container {
        width: auto;
        position: fixed;
        z-index: 1000;
        background-color: #fff;
      }

    </style>
  </head>
  <body>
    
    <div id="slider_container" class="slider_container">
        <input type="button" id="reset" value="Reset" onClick="resetParameters();" />
        <input type="button" id="export" value="Export" onClick="exportParameters();" />
        <input type="button" id="hide" value="Hide" onClick="document.querySelector('#parameters_container').hidden = !document.querySelector('#parameters_container').hidden;" />
        <label for="animate">Animate</label>
        <input type="checkbox" id="animate" checked />
        <a href="https://github.com/nickyreinert/prime_spiral" id="doc" target="_blank">Source & Documentation</a>
        <table id="parameters_container">
        </table>    
    </div>    

    <div id="container">
        <canvas id="canvas" width="500" height="500"></canvas>
    </div>

    <script>

    function resetParameters() {
        
        document.getElementById('parameters_container').remove();
        var parameters_container = document.createElement('table');
        parameters_container.id = 'parameters_container';
        document.getElementById('slider_container').appendChild(parameters_container);

        window.parameters = JSON.parse(JSON.stringify(default_parameters));
        window.config = JSON.parse(JSON.stringify(default_config));

        document.location.search = '';

        saveSettingsToCookie();

        addParameterControls(); 
        
        registerParameterControls();
        
        controlAnimation();
        
    }

    function importParameters() {

        let settings = document.location.search;

        try {

            settings = JSON.parse(atob(settings.substring(1)));

            parameters = settings.parameters;
            config = settings.config;

            if (parameters == undefined || config == undefined) {

                throw 'no parameters or config found';

            }

        } catch (e) {

            return settings_received;

        }
        
        settings_received = true;

        window.parameters = parameters;
        window.config = config;

        return settings_received;

    }

    function exportParameters() {
        
        document.location.search = '?' +  btoa(JSON.stringify({config: config, parameters: parameters}));

    }

    function getCookie(name) {
        
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(name + '=');
            if (c_start!=-1) {

                c_start = c_start + name.length + 1;
                c_end = document.cookie.indexOf(';', c_start);
                
                if (c_end == -1) {c_end = document.cookie.length;}
                
                return unescape(document.cookie.substring(c_start,c_end));

            }
        }

        return "";
    }

    function saveSettingsToCookie() {

        // save everything to the cookie, for next reload
        let date = new Date();
        date.setTime(date.getTime() + (365 * 24 * 60 * 60 * 1000));
        const expires = "expires=" + date.toUTCString();

        document.cookie = 'settings=' + escape(JSON.stringify({config: window.config, parameters: window.parameters})) + '; SameSite=None; Secure; ' + expires;

    }

    function restoreParameters() {

        settings_received = false;

        let settings = getCookie('settings');

        try {

            settings = JSON.parse(unescape(settings));

            parameters = settings.parameters;
            config = settings.config;

            if (parameters == undefined || config == undefined) {

                throw 'no parameters or config found';

            }

        } catch (e) {

            return settings_received;

        }
        
        settings_received = true;

        window.parameters = parameters;
        window.config = config;

        return settings_received;

    }

    function addParameterControls() {

        for (const [key, value] of Object.entries(config)) {

            var container = document.createElement('tr');
            if (value.value === true || value.value === false) {
                
                if (value.value == true) {var checked = 'checked'} else {var checked = ''};
                container.innerHTML = 
                    '<td><label " for="' + key + '" />' + value.descr + '</label></td>' + 
                    '<td><input type="checkbox" size=3 ' + checked + ' " id="value_' + key + '" /></td>';

            } else {

                container.innerHTML =
                    '<td><label " for="' + key + '" />' + value.descr + '</label></td>' + 
                    '<td><input type="text" size=8 value="' + value.value + '" id="value_' + key + '" /></td>';

            }
            
            document.getElementById('parameters_container').appendChild(container);

        }

        var container = document.createElement('tr');
        container.innerHTML  = '<td>Param</td>';
        container.innerHTML += '<td>Value</td>';
        container.innerHTML += '<td>Range</td>';
        container.innerHTML += '<td>Anim</td>';
        container.innerHTML += '<td>Min</td>';
        container.innerHTML += '<td>Max</td>';
        container.innerHTML += '<td>Steps</td>';

        document.getElementById('parameters_container').appendChild(container);

        for (const [key, value] of Object.entries(window.parameters)) {

            var container = document.createElement('tr');
            if (value.animate == true) {var checked = 'checked'; animated_parameters += 1;} else {var checked = ''};
            container.innerHTML = '<td>' + value.descr + ': </td>' +
                '<td><input type="text" size=3 value="' + value.value + '" id="value_' + key + '" /></td>' +
                '<td><input id="slider_' + key + '" ' +
                    'type="range" ' +
                    'min="' + value.min + '" ' +
                    'max="' + value.max + '" ' +
                    'step="' + value.step + '" ' +
                    'defaultValue="' + value.value + '" ' +
                    'value="' + value.value + '"/></td>' +
                '<td><input type="checkbox" ' +'id="animate_' + key + '" ' + checked + '/></td>' +
                '<td><input type="text" size=4 value="' + value.min + '" id="min_' + key + '" /></td>' +
                '<td><input type="text" size=4 value="' + value.max + '" id="max_' + key + '" /></td>' +
                '<td><input type="text" size=4 value="' + value.step + '" id="step_' + key + '" /></td>';
            
            document.getElementById('parameters_container').appendChild(container);

        }
    }
    
    function registerParameterControls() {

        for (const [key, value] of Object.entries(config)) {

            let current_control = document.querySelector('#value_' + key);

            if (value.value === true ||value.value === false) {

                current_control.onclick = function(event) {
                    
                    let parameter_and_setting = event.target.getAttribute('id');
                    let setting = parameter_and_setting.split('_')[0];
                    let name= parameter_and_setting.replace('value_', '');
                    
                    window.config[name]['value'] = event.target.checked;
                    
                    controlAnimation();

                }

            } else {

                current_control.addEventListener('input', (event) => {

                    let parameter_and_setting = event.target.getAttribute('id');
                    let setting = parameter_and_setting.split('_')[0];
                    let name= parameter_and_setting.replace('value_', '');
                    
                    window.config[name]['value'] = event.target.value;

                    controlAnimation();

                })
            
            }
                
        }

        for (const [key, value] of Object.entries(parameters)) {

            const controls = ['slider', 'min', 'max', 'step', 'value', 'animate'];
            for (const control of controls) {

                let current_control = document.querySelector('#' + control + '_' + key);

                if (control == 'animate') {

                    current_control.onclick = function(event) {

                        // extract the parameter, setting (min, max, ...) and value
                        let parameter_and_setting = event.target.getAttribute('id');
                        let parameter = parameter_and_setting.split('_')[1];

                        if (event.target.checked) {

                            window.parameters[parameter]['animate'] = true;
                        
                            animated_parameters += 1;

                        } else {

                            window.parameters[parameter]['animate'] = false;

                            animated_parameters -= 1;

                        }

                        saveSettingsToCookie();

                        controlAnimation();

                    }


                } else {

                    current_control.addEventListener('input', (event) => {

                        // extract the parameter, setting (min, max, ...) and value
                        let parameter_and_setting = event.target.getAttribute('id');
                        let setting = parameter_and_setting.split('_')[0];
                        let parameter = parameter_and_setting.split('_')[1];
                        let value = event.target.value
                        
                        // the slider is the only one that also controls the "value" 
                        // of the current parameter
                        if (setting == 'slider') {
                        
                            // set the global parameter object
                            window.parameters[parameter]['value'] = value;
                            
                        // if not the slider, then it's the value, min, max or step value
                        // which also impacts the slider
                        } else {

                            window.parameters[parameter][setting] = value;
                            let slider = document.querySelector('#slider_' + parameter);
                            slider[setting] = value;
                            // also check if the current value outreaches the current slider range
                            if (slider.max < slider.value) {
                                slider.value = slider.max;
                                window.parameters[parameter]['value'] = value;
                            } else if (slider.min > slider.value) {
                                slider.value = slider.min;
                                window.parameters[parameter]['value'] = value;
                            }

                        }

                        saveSettingsToCookie();

                        drawSpiral();

                   })

                } // curent_control != animate
            }
            
        }

    }

    function listenToScreenSizeChanges() {
      
        window.addEventListener("resize", function() {
        fitElementToScreen(document.getElementById('container'));
        drawSpiral(parameters);

      });

    }
      
    function numberIsPrime(num) {
        
        if (num < 2) {return false;}

        if (primes.includes(num)) return true;

        for(let i = 2, s = Math.sqrt(num); i <= s; i++) {

            if (num % i  === 0) return false;
        
        }

        primes.push(num);

        return true;
    }

    function hexToRgb(hex) {
        // thanks to https://stackoverflow.com/a/5624139/2360229
        // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
        var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
        hex = hex.replace(shorthandRegex, function(m, r, g, b) {
            return r + r + g + g + b + b;
        });

        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }

    function fitElementToScreen(element) {

        var screenWidth = window.innerWidth;
        var screenHeight = window.innerHeight;

        element.style.width = screenWidth + "px";
        element.style.height = screenHeight + "px";
    }

    function drawSpiral() {
        
        for (const [key, attributes] of Object.entries(parameters)) {

            document.querySelector('#slider_' + key).value = attributes.value;
            document.querySelector('#value_' + key).value = attributes.value;

        }

        // init main canvas container
        var screenWidth = window.innerWidth;
        var screenHeight = window.innerHeight;

        var canvas_container = document.getElementById('canvas');
        var context_container = canvas_container.getContext('2d');

        canvas_container.style.width = screenWidth + 'px';
        canvas_container.style.height = screenHeight + 'px';
        canvas_container.width = screenWidth * parseInt(config.scale.value);
        canvas_container.height = screenHeight * parseInt(config.scale.value);
        context_container.clearRect(0, 0, screenWidth, screenHeight);

        // init additional canvas layers
        var canvases = {};
        var contexts = {};
        var visuals = ['lines', 'rays', 'dots'];

        for (visual in visuals) {
                
            canvases[visuals[visual]] = document.createElement('canvas');
            contexts[visuals[visual]] = canvases[visuals[visual]].getContext('2d');

            canvases[visuals[visual]].width = screenWidth * parseInt(config.scale.value);
            canvases[visuals[visual]].height = screenHeight * parseInt(config.scale.value);

            contexts[visuals[visual]].clearRect(0, 0, screenWidth, screenHeight);

        }

        // context_dots.globalAlpha = 0.5;

        num = 2;

        var centerx = contexts['lines'].canvas.width / 2;
        var centery = contexts['lines'].canvas.height / 2;

        contexts['lines'].moveTo(centerx, centery);
        contexts['lines'].beginPath();

        max_ray_width = parameters.range.value;

        contexts['dots'].lineWidth = 5;

        prime_fill_color_rgb = hexToRgb(config.prime_fill_color.value);
        contexts['dots'].lineCap = "round";

        for (i = 0; i < parseInt(parameters.range.value); i++) {

            num = num + 1;

            angle = (parseFloat((parameters.smoother.value)) * i) + parseFloat(parameters.rotation.value)
            x = centerx + (parseInt(parameters.a.value) + parseFloat(parameters.b.value) * angle) * Math.sin(angle);
            y = centery + (parseInt(parameters.a.value) + parseFloat(parameters.b.value) * angle) * Math.cos(angle);


            if (numberIsPrime(num)) {

                drawArcs(x, y, contexts['dots']);

                drawRays(x, y, centerx, centery, contexts['rays']);

                if (config.show_primes.value == true) {
                    contexts['lines'].fillText(num, x, y);
                }
                
            }
            
            if (config.show_numbers.value == true) {
                contexts['lines'].fillText(num, x + 5 , y + 5);
            } 

            contexts['lines'].lineTo(x, y);
            // context_lines.arc(x, y, 2, 0, 2 * Math.PI);
            // context_lines.fillText('angel: ' + parseInt(angle) + ', x: ' + parseInt(x) + ', y:' + parseInt(y), x, y);

        }

        if (config.general_fill_color.value.includes('#')) {
            contexts['lines'].fillStyle = config.general_fill_color.value;
            contexts['lines'].fill();
        }
        if (config.general_outline_color.value.includes('#')) {
            contexts['lines'].strokeStyle = config.general_outline_color.value;
            contexts['lines'].stroke();
        }

        for (visual in visuals) {
            context_container.drawImage(canvases[visuals[visual]], 0, 0);
        }

    }

    function drawRays(x, y, centerx, centery, context) {

        if (config.show_primes_rays.value == true) {
            
            
            if (config.relative_line_width.value == true) {
                
                context.lineWidth = 100 - parseInt(100 * i / max_ray_width);
                
            }
            
            context.beginPath();

            context.moveTo(centerx, centery);
            
            context.lineTo(x, y);

            context.stroke();
        
        }

    }

    function drawArcs(x, y, context_dots) {

        context_dots.beginPath();
        
        // set position
        context_dots.arc(x, y, parseInt(parameters.r.value), 0, 2 * Math.PI);
        
        // fill the arc
        if (config.prime_fill_color.value.includes('#')) {

            if (config.fading_fill_color.value == true){
                factor = Math.round((100 - Math.floor(100 * i / parameters.range.value))) / 100
                context_dots.fillStyle = "rgba(" +
                    Math.floor(255 - prime_fill_color_rgb.r * factor) + "," +
                    Math.floor(255 - prime_fill_color_rgb.g * factor) + "," +
                    Math.floor(255 - prime_fill_color_rgb.b * factor) + "," +
                    Math.floor(1) + 
                    ")";

            } else {

                context_dots.fillStyle = config.prime_fill_color.value;

            }
            
            context_dots.fill();

        }

        // draw outline
        if (config.prime_outline_color.value.includes('#')) {

            context_dots.strokeStyle = config.prime_outline_color.value;
            context_dots.stroke();
            
        }

    }

    function controlAnimation() {
        
        if (document.querySelector('#animate').checked) {window.animation = true}

        if (window.animated_parameters <= 0) {window.animation = false}

        drawSpiral();

        if (typeof(loop) != 'undefined') {
                        
            window.clearInterval(loop);

        }

        if (window.animation == true) {
            
            loop = setInterval(animateDrawing, parseInt(document.querySelector('#value_delay').value));

        }

    }

    function animateDrawing() {

        for (const [key, attributes] of Object.entries(parameters)) {

            if (document.querySelector('#animate_' + key).checked) {

                if (parameters[key]['direction'] == 'inc') {
                    if (parameters[key]['type'] == 'float') {
                        parameters[key]['value'] = parseFloat(parameters[key]['value']) + parseFloat(parameters[key]['step']);
                    } else if (parameters[key]['type'] == 'int') {
                        parameters[key]['value'] = parseInt(parameters[key]['value']) + parseInt(parameters[key]['step']);
                    }
                    
                    if (parameters[key]['value'] > parameters[key]['max']) {
                        parameters[key]['direction'] = 'dec';
                    }
                } else if (parameters[key]['direction'] == 'dec') {
                    if (parameters[key]['type'] == 'float') {
                        parameters[key]['value'] = parseFloat(parameters[key]['value']) - parseFloat(parameters[key]['step']);
                    } else if (parameters[key]['type'] == 'int') {
                        parameters[key]['value'] = parseInt(parameters[key]['value']) - parseInt(parameters[key]['step']);
                    }
                    
                    if (parameters[key]['value'] < parameters[key]['min']) {
                        parameters[key]['direction'] = 'inc';
                    }
                }

            }
            
        }
        
        drawSpiral();
    }

    function registerAnimationControlParameters() {
        
        let animate = document.querySelector('#animate');

        animate.onclick = function(event) {

            if (event.target.checked) {
                
                window.animation = true;

            } else {

                window.animation = false;

            }

            controlAnimation();

        }

        document.addEventListener('keydown', function(event) {

        if (event.key == 'Escape') {

            window.animation = !window.animation;

            let animate = document.querySelector('#animate');
            
            animate.checked = !animate.checked;

            controlAnimation();

        }

        });


    }

    var primes = [];

    const animation = true;
    
    var animated_parameters = 0;

    const default_config = {
            'delay':                {value: 10, descr: 'Delay'},
            'show_numbers':         {value: false, descr: 'Show numbers'},
            'show_primes':          {value: false, descr: 'Show prime numbers'},
            'show_primes_rays':     {value: false, descr: 'Prime rays from the center'},
            'relative_line_width':   {value: false, descr: 'Relative line width'},
            'prime_outline_color':  {value: '#ff0000', descr: 'Prime arc outline color'},
            'prime_fill_color':     {value: '#bb9999', descr: 'Prime arc fill color'},
            'fading_fill_color':    {value: false, descr: 'Fill color fades out'},
            'general_outline_color': {value: '#353535', descr: 'General outline color'},
            'general_fill_color':   {value: '', descr: 'General fill color'},
            'scale':                {value: 1, descr: 'Resolution scale'}
        }

    const default_parameters = {
        range:      {value: 360, min: 90, max: 1440 * 1, step: 1, descr: 'Range', type: 'int', animate: false, direction: 'inc'},
        smoother:   {value: 0.1, min: 0, max: 1, step: 0.0001, descr: 'Density', type: 'float', animate: true, direction: 'inc'},
        rotation:   {value: 0, min: -90, max: 90, step: 0.1, descr: 'Rotation', type: 'float', animate: false, direction: 'inc'},
        a:          {value: 100, min: 0, max: 5, step: 0.01, descr: 'Slope', type: 'float', animate: true, direction: 'inc'},
        b:          {value: 5, min: 0, max: 10, step: 0.01, descr: 'Intercept', type: 'float', animate: true, direction: 'inc'},
        r:          {value: 3, min: 1, max: 100, step: 1, descr: 'Radius', type: 'float', animate: false, direction: 'inc'}
    }

    // first try to read settings from cookie
    var settings_received = restoreParameters();

    // then try to read settings from URL
    settings_received = importParameters();

    if (typeof(settings_received) == 'undefined' || !settings_received) {
        
        parameters = JSON.parse(JSON.stringify(default_parameters));
        config = JSON.parse(JSON.stringify(default_config));

        saveSettingsToCookie();

    } 

    addParameterControls();
    
    registerAnimationControlParameters();

    registerParameterControls();

    controlAnimation();

    listenToScreenSizeChanges();

    fitElementToScreen(document.getElementById('container'));

    drawSpiral();

    </script>
</body>